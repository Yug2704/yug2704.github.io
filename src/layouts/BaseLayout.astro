---
import citiesJson from "../data/_index_cities.json";
import countriesJson from "../data/_index_countries.json";

const {
  title = "Prix de la vie",
  description = "Comparez les prix par pays et par villes — toujours vs France."
} = Astro.props;

// On prépare les données à injecter dans le <script> côté client
const CITIES = citiesJson;
const COUNTRIES = countriesJson;
---
<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <style>
      :root{
        --bg:#ffffff; --text:#111827; --muted:#4b5563; --line:#e5e7eb;
        --card:#ffffff; --shadow:0 6px 18px rgba(17,24,39,.06);
        --accent:#ff4d8d; --accent-600:#ef437f; --accent-100:#fff1f6;
        --footer-bg:#fff1f6; --footer-strong:#ff8db2; --footer-strong-2:#ff6a9c;
      }
      *{box-sizing:border-box}
      html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
      a{color:inherit;text-decoration:none}
      .container{max-width:1100px;margin:0 auto;padding:16px}

      header{position:sticky;top:0;background:linear-gradient(90deg,#fff5f9 0%,#ffffff 50%,#fff5f9 100%);
        backdrop-filter:saturate(1.2) blur(8px);border-bottom:2px solid #ffd0df;
        box-shadow:0 2px 12px rgba(255,128,171,.1);z-index:10}
      header .container a:first-child{color:#a61b4d;font-weight:700}

      .pill{background:#fff;border:1px solid #ffd0df;border-radius:999px;padding:6px 12px;color:#a61b4d;transition:all .15s}
      .pill:hover{background:#ffe4ec;border-color:#ffb4c8}

      .search{display:flex;align-items:center;gap:8px}
      .search input{border:1px solid #ffd0df;border-radius:999px;padding:6px 12px;outline:none}
      .search input:focus{border-color:#ff8db2;box-shadow:0 0 0 2px #ffdee9}

      .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
      .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
      .btn{display:inline-block;padding:.65rem 1rem;border-radius:999px;background:var(--accent);color:#fff;border:1px solid transparent;box-shadow:0 2px 12px rgba(255,128,171,.1)}
      .btn:hover{background:var(--accent-600)}

      .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
      .chip{display:inline-block;padding:8px 12px;border-radius:999px;background:var(--accent-100);color:#a61b4d;border:1px solid #ffd0df;font-size:.95rem;box-shadow:var(--shadow);transition:all .15s}
      .chip:hover{filter:brightness(1.05);transform:translateY(-1px)}

      .site-bottom{margin-top:36px}
      .site-bottom .info{background:var(--footer-bg);border-top:1px solid #ffd0df;border-bottom:1px solid #ffd0df}
      .info-inner{display:grid;gap:22px;grid-template-columns:1.2fr .8fr;align-items:start;padding:28px 16px}
      .info h3{margin:0 0 8px} .info p{color:var(--muted);line-height:1.65;margin:0}
      .links ul{list-style:none;margin:8px 0 0;padding:0}
      .links li{margin:6px 0} .links a{color:#a61b4d} .links a:hover{text-decoration:underline}

      .footer-strong{background:linear-gradient(0deg,var(--footer-strong),var(--footer-strong-2));color:#fff}
      .footer-strong-inner{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:16px}
      .footer-strong a{color:#fff;background:rgba(255,255,255,.15)}
    </style>
  </head>
  <body>
    <header>
      <div class="container" style="display:flex;justify-content:space-between;align-items:center;height:64px;gap:12px;">
        <a href="/" style="font-weight:700">Prix de la vie</a>
        <nav style="display:flex;gap:12px;align-items:center;">
          <a class="pill" href="/">Accueil</a>
          <a class="pill" href="/category/restaurant">Toutes catégories</a>
          <form id="site-search" class="search" role="search" action="/search" method="GET">
            <input name="q" placeholder="Pays ou ville…" autocomplete="off" />
            <button class="pill" type="submit">Chercher</button>
          </form>
        </nav>
      </div>
    </header>

    <main class="container">
      <slot />
    </main>

    <section class="site-bottom">
      <div class="info">
        <div class="container info-inner">
          <div>
            <h3>À propos</h3>
            <p>
              Prix de la vie compare des prix de biens et services dans différents pays et villes,
              avec une référence claire : la France.
            </p>
          </div>
          <div class="links">
            <h3>Pages</h3>
            <ul>
              <li><a href="/">Accueil</a></li>
              <li><a href="/country/france">France</a></li>
              <li><a href="/sitemap.xml">Sitemap</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="footer-strong">
        <div class="container footer-strong-inner">
          <span>© {new Date().getFullYear()} Prix de la vie</span>
          <a class="pill" href="/sitemap.xml">sitemap</a>
        </div>
      </div>
    </section>

    <!-- Recherche : intercepte toutes les barres + route unique /country/<slug> -->
    <script is:inline>
      const CITIES = {JSON.stringify(CITIES)};
      const COUNTRIES = {JSON.stringify(COUNTRIES)};

      const slugify = (s) =>
        String(s || "").toLowerCase()
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");

      function handleSearchSubmit(e){
        const form = e.target;
        if (!(form instanceof HTMLFormElement)) return;

        const isSearch = form.getAttribute("role")==="search"
          || form.querySelector('input[name="q"], input[type="search"], input[type="text"]');

        if (!isSearch) return;
        e.preventDefault();

        let q = new FormData(form).get("q") || "";
        if (!q) {
          const input =
            form.querySelector('input[name="q"]') ||
            form.querySelector('input[type="search"]') ||
            form.querySelector('input[type="text"]');
          if (input) q = input.value || "";
        }
        const s = slugify(q);
        if (!s) { window.location.href = `/search?q=${encodeURIComponent(q)}`; return; }

        const city = CITIES.find(c => c.slug === s || slugify(c.name) === s);
        if (city) { window.location.href = `/country/${city.slug}`; return; }

        const country = COUNTRIES.find(c => c.slug === s || slugify(c.name) === s);
        if (country) { window.location.href = `/country/${country.slug}`; return; }

        window.location.href = `/search?q=${encodeURIComponent(q)}`;
      }

      document.addEventListener("submit", handleSearchSubmit, true);
      document.querySelectorAll('form[role="search"]').forEach(f=>{
        if(!f.getAttribute('action')) f.setAttribute('action','/search');
        if(!f.getAttribute('method')) f.setAttribute('method','GET');
      });
    </script>
  </body>
</html>
