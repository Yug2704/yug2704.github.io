---
// src/pages/search.astro
import cities from "../data/_index_cities.json";
import countries from "../data/_index_countries.json";

const title = "Recherche";
const description = "Recherche de pays ou villes";
---

<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="robots" content="noindex,follow" />
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;margin:0}
      .wrap{max-width:900px;margin:0 auto;padding:24px}
      .muted{color:#64748b}
      ul{margin:10px 0 0 18px}
      a{color:#a61b4d}
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Recherche</h1>
      <p class="muted" id="status">Analyse de votre requête…</p>
      <div id="results"></div>
    </div>

    <!-- On sérialise les données en JSON “safe” -->
    <script type="application/json" id="data-cities">{JSON.stringify(cities)}</script>
    <script type="application/json" id="data-countries">{JSON.stringify(countries)}</script>

    <script>
      // lecture sûre des JSON embarqués
      const CITIES     = JSON.parse(document.getElementById('data-cities').textContent || '[]');
      const COUNTRIES  = JSON.parse(document.getElementById('data-countries').textContent || '[]');

      const slugify = (s) =>
        String(s || "")
          .toLowerCase()
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/(^-|-$)/g, "");

      const params  = new URLSearchParams(location.search);
      const q       = (params.get("q") || "").trim();
      const s       = slugify(q);

      const $status  = document.getElementById("status");
      const $results = document.getElementById("results");

      try {
        if (!q) {
          $status.textContent = "Saisissez un terme de recherche.";
        } else {
          // 1) ville exacte
          const city = CITIES.find(c => c.slug === s || slugify(c.name) === s);
          if (city) { location.replace(`/city/${city.slug}`); }

          // 2) pays exact
          const country = COUNTRIES.find(c => c.slug === s || slugify(c.name) === s);
          if (country) { location.replace(`/country/${country.slug}`); }

          // 3) suggestions (fuzzy)
          const inc = (x) => slugify(x).includes(s);
          const cityHits    = CITIES.filter(c => inc(c.name) || inc(c.slug)).slice(0, 10);
          const countryHits = COUNTRIES.filter(c => inc(c.name) || inc(c.slug)).slice(0, 10);

          if (cityHits.length === 0 && countryHits.length === 0) {
            $status.textContent = `Aucun résultat pour « ${q} ».`;
          } else {
            $status.textContent = `Résultats pour « ${q} » :`;
            const ul = document.createElement("ul");
            countryHits.forEach(c => {
              const li = document.createElement("li");
              li.innerHTML = `Pays : <a href="/country/${c.slug}">${c.name}</a>`;
              ul.appendChild(li);
            });
            cityHits.forEach(c => {
              const li = document.createElement("li");
              li.innerHTML = `Ville : <a href="/city/${c.slug}">${c.name}</a>`;
              ul.appendChild(li);
            });
            $results.appendChild(ul);
          }
        }
      } catch (e) {
        console.error(e);
        $status.textContent = "Erreur pendant la recherche.";
      }
    </script>
  </body>
</html>
