---
import BaseLayout from "../../layouts/BaseLayout.astro";
import KpiCard from "../../components/KpiCard.astro";

/* 1) ROUTES STATIQUES */
export function getStaticPaths() {
  const files = import.meta.glob("../../data/countries/*.json", { eager: true });
  const ALL = Object.values(files).map((m) => m.default ?? m);

  return ALL.map((c) => ({
    params: { country: c.slug },
    props: { country: c },
  }));
}

/* 2) DONN√âES DE PAGE */
const filesPage = import.meta.glob("../../data/countries/*.json", { eager: true });
const ALL_PAGE = Object.values(filesPage).map((m) => m.default ?? m);

const { country } = Astro.props;
const FR = ALL_PAGE.find((c) => c.slug === "france");
const isFrance = country.slug === "france";

/* Helpers */
function eur(n){ return Number(n).toLocaleString("fr-FR",{style:"currency",currency:"EUR"}); }
function diffLabel(val, ref){
  if (isFrance) return { text: "r√©f√©rence France", color: "var(--muted)" };
  if (val == null || ref == null) return { text: "‚Äî", color: "var(--muted)" };
  const pct = ((val - ref)/ref)*100, abs = Math.abs(pct);
  if (!isFinite(pct)) return { text: "‚Äî", color: "var(--muted)" };
  if (abs < 1) return { text: "similaire", color: "var(--muted)" };
  return pct < 0 ? { text: `${abs.toFixed(0)}% moins cher`, color: "var(--green)" }
                 : { text: `${abs.toFixed(0)}% plus cher`,  color: "var(--red)" };
}

/* KPI √† afficher */
const KPIS = [
  { key:"restaurant",   label:"Repas au restaurant",                     icon:"üçΩÔ∏è", fmt:eur },
  { key:"salaireNet",   label:"Salaire mensuel net moyen",               icon:"üí∞",  fmt:eur },
  { key:"loyer",        label:"Loyer mensuel (1 chambre, centre-ville)", icon:"üè†",  fmt:eur },
  { key:"essence",      label:"Essence (1 L)",                            icon:"‚õΩ",  fmt:eur },
  { key:"cigarettes",   label:"Cigarettes (paquet)",                      icon:"üö¨",  fmt:eur },
  { key:"cinema",       label:"Cin√©ma (1 place)",                         icon:"üé¨",  fmt:eur },
  { key:"hotel",        label:"H√¥tel (1 nuit)",                           icon:"üõéÔ∏è",  fmt:eur },
  { key:"habiterIndex", label:"Indice ‚ÄúHabiter‚Äù",                         icon:"üè°",  fmt:(n)=>String(n) }, // ‚Üê COMMA HERE

  // nouvelles cat√©gories
  { key:"eau1l",          label:"Bouteille d‚Äôeau (1 L)",               icon:"üíß", fmt:eur },
  { key:"transportLocal", label:"Transports en commun (ticket)",       icon:"üöç", fmt:eur },
  { key:"billetAvion",    label:"Billet d‚Äôavion A/R depuis la France", icon:"‚úàÔ∏è", fmt:eur },
  { key:"train",          label:"Train (trajet interurbain)",          icon:"üöÜ", fmt:eur },
  { key:"forfaitMobile",  label:"Forfait mobile (mensuel)",            icon:"üì±", fmt:eur },
];

/* map clef KPI -> slug cat√©gorie */
function keyToCategorySlug(key){
  if (key === "salaireNet")   return "salaire";
  if (key === "habiterIndex") return "habiter";
  return key; // restaurant, loyer, essence, cigarettes, cinema, hotel, eau1l, transportLocal, billetAvion, train, forfaitMobile
}

/* Titre + banni√®re */
const title = isFrance
  ? "Prix de la vie en France (r√©f√©rence)"
  : `Prix de la vie en ${country.name} (compar√© √† la France)`;
const bannerSrc  = country.banner     || `/banners/${country.slug}.jpg`;
const aboutTitle = country.aboutTitle || `√Ä savoir sur ${country.name}`;

/* Date de mise √† jour */
const lastUpdatedRaw = country.meta?.lastUpdated;
const lastUpdated = lastUpdatedRaw ? new Date(lastUpdatedRaw) : null;
const lastUpdatedStr = lastUpdated
  ? lastUpdated.toLocaleDateString("fr-FR", { year: "numeric", month: "long", day: "numeric" })
  : null;
---

<BaseLayout title={title}>
  <style>
    :root{ --red:#e03131; --green:#2f9e44; }

    .intro {
      background: var(--accent-100);
      border: 1px solid #ffd0df;
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 4px 12px rgba(255, 128, 171, 0.08);
      margin-top: 20px;
    }

    .about-box {
      position: relative;
      background: #fff;
      border: 1px solid #e9edf3;
      border-radius: 18px;
      padding: 20px 22px 20px 26px;
      box-shadow: 0 10px 28px rgba(17,24,39,.06), 0 2px 10px rgba(255, 77, 141, .06);
    }
    .about-box::before{
      content:"";
      position:absolute; inset:14px auto 14px 12px;
      width:4px; border-radius:999px;
      background: linear-gradient(180deg,#ff8db2,#ffd0df);
      opacity:.9;
    }
    .about-box p { color: var(--muted); line-height: 1.7; margin: 0 0 12px 0; }
    .about-box p:last-child { margin-bottom: 0; }

    .last-updated {
      margin-top: 8px;
      font-size: 0.9rem;
      color: var(--muted);
    }
  </style>

  <!-- Banni√®re -->
  <div class="banner" style="margin:18px 0;border:1px solid var(--line);border-radius:18px;overflow:hidden;box-shadow:var(--shadow);">
    <img src={bannerSrc} alt={`Banni√®re ${country.name}`} style="width:100%;height:220px;object-fit:cover;" />
  </div>

  <!-- Intro -->
  <div class="intro">
    <h1 style="margin:0 0 10px 0;font-size:1.8rem;">
      {country.name} {isFrance ? "üá´üá∑ ‚Äî R√©f√©rence" : "‚Äî Compar√© √† la France"}
    </h1>
    <p style="color:var(--muted);font-size:1.05rem;line-height:1.6;margin:0;">
      {isFrance
        ? "Cette page pr√©sente les valeurs de r√©f√©rence utilis√©es pour comparer les autres pays."
        : "Aper√ßu des co√ªts moyens avec comparaison directe √† la r√©f√©rence France. Les valeurs peuvent varier selon la ville."}
    </p>
    {lastUpdatedStr && (
      <p class="last-updated">
        Donn√©es mises √† jour le {lastUpdatedStr}.
      </p>
    )}
  </div>

  <!-- Chiffres cl√©s -->
  <h2 style="margin-top:26px;">Chiffres cl√©s {isFrance ? "(r√©f√©rence France)" : "(vs France)"}</h2>
  <div style="background:var(--accent-100);border:1px solid #ffd0df;border-radius:18px;padding:24px;margin-top:14px;box-shadow:var(--shadow);">
    <div class="grid">
      {KPIS.map((k) => {
        const val   = country.kpis[k.key];
        const ref   = FR.kpis[k.key];
        const diff  = diffLabel(val, ref);

        const value = (val == null) ? "‚Äî" : (k.fmt ? k.fmt(val) : String(val));
        const frRaw = ref;
        const frVal = k.key === "habiterIndex"
          ? "France = 100"
          : (frRaw == null ? "‚Äî" : (k.fmt ? k.fmt(frRaw) : String(frRaw)));

        const diffHtml = isFrance ? null : `<strong style="color:${diff.color}">${diff.text}</strong>`;
        const categorySlug = keyToCategorySlug(k.key);

        return (
          <KpiCard
            icon={k.icon}
            label={k.label}
            value={value}
            frValue={frVal}
            diffHtml={diffHtml}
            countrySlug={country.slug}
            categorySlug={categorySlug}
          />
        );
      })}
    </div>
  </div>

  <!-- √Ä propos -->
  <h2 style="margin-top:26px;">{aboutTitle}</h2>
  <div class="about-box">
    {country.notes?.map((p) => <p>{p}</p>)}
  </div>
</BaseLayout>
