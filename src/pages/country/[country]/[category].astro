---
import BaseLayout from "../../../layouts/BaseLayout.astro";

/* --------- DATA LOADING --------- */
// Pays
const countryFiles = import.meta.glob("../../../data/countries/*.json", { eager: true });
const COUNTRIES = Object.values(countryFiles).map((m:any)=>m.default ?? m);
// France de r√©f√©rence
const FR = COUNTRIES.find((c:any)=>c.slug==="france");

// Cat√©gories (slugs affichables)
import cats from "../../../data/categories.json"; // ["restaurant","salaire","loyer","essence","cinema","hotel","habiter"]

// mapping slug cat√©gorie -> cl√© dans JSON kpis
const keyByCategory: Record<string,string> = {
  restaurant: "restaurant",
  salaire:    "salaireNet",
  loyer:      "loyer",
  essence:    "essence",
  cinema:     "cinema",
  hotel:      "hotel",
  habiter:    "habiterIndex",
};

// g√©n√©rer toutes les routes statiques
export function getStaticPaths() {
  const paths = [];
  for (const c of COUNTRIES) {
    for (const cat of cats) {
      // Only if the KPI exists in the country JSON
      const key = keyByCategory[cat];
      if (key && c.kpis && key in c.kpis) {
        paths.push({
          params: { country: c.slug, category: cat },
          props: { country: c, category: cat },
        });
      }
    }
  }
  return paths;
}

const { country, category } = Astro.props;
const isFrance = country.slug === "france";
const key = keyByCategory[category];
const val = country.kpis[key];
const ref = FR.kpis[key];

/* --------- HELPERS --------- */
const TITLES: Record<string, string> = {
  restaurant: "Repas au restaurant",
  salaire: "Salaire mensuel net moyen",
  loyer: "Loyer (1 chambre, centre-ville)",
  essence: "Essence (1 L)",
  cinema: "Cin√©ma (1 place)",
  hotel: "H√¥tel (1 nuit)",
  habiter: "Indice ‚ÄúHabiter‚Äù",
};
function eur(n:number){ return Number(n).toLocaleString("fr-FR",{style:"currency",currency:"EUR"}); }
function formatValue(cat:string, n:number){
  if (cat==="habiter") return String(n);
  if (cat==="salaire" || cat==="loyer" || cat==="restaurant" || cat==="cinema" || cat==="hotel") return eur(n);
  if (cat==="essence") return n.toLocaleString("fr-FR",{minimumFractionDigits:2,maximumFractionDigits:2})+" ‚Ç¨";
  return String(n);
}
function diffLabel(){
  if (isFrance) return { text:"r√©f√©rence France", color:"var(--muted)" };
  const pct = ((val - ref)/ref)*100, abs = Math.abs(pct);
  if (!isFinite(pct)) return { text:"‚Äî", color:"var(--muted)" };
  if (abs < 1) return { text:"similaire", color:"var(--muted)" };
  return pct < 0 ? { text:`${abs.toFixed(0)}% moins cher`, color:"var(--green)" }
                 : { text:`${abs.toFixed(0)}% plus cher`,  color:"var(--red)" };
}
const bannerSrc = country.banner || `/banners/${country.slug}.jpg`;

/* --------- PRESENTATION --------- */
const pretty = TITLES[category] ?? category;
const pageTitle = `${pretty} ‚Äî ${country.name}${isFrance ? " (r√©f√©rence)" : " (vs France)"}`;
const valueText = formatValue(category, val);
const frText    = (category==="habiter") ? "France = 100" : formatValue(category, ref);
const d = diffLabel();
---
<BaseLayout title={pageTitle}>
  <div class="banner" style="margin:18px 0;border:1px solid var(--line);border-radius:18px;overflow:hidden;box-shadow:var(--shadow);">
    <img src={bannerSrc} alt={`Banni√®re ${country.name}`} style="width:100%;height:220px;object-fit:cover;" />
  </div>

  <div class="card" style="background:var(--accent-100);margin-top:20px;">
    <h1 style="margin:0 0 10px 0;font-size:1.8rem;">
      {pretty} ‚Äî {country.name} {isFrance ? "üá´üá∑" : ""}
    </h1>
    <p style="color:var(--muted);font-size:1.05rem;line-height:1.6;margin:0;">
      Donn√©e d√©taill√©e pour {country.name}. Toutes les valeurs sont compar√©es √† la r√©f√©rence France.
    </p>
  </div>

  <div style="display:grid;grid-template-columns:1.1fr .9fr;gap:14px;margin-top:16px;">
    <div class="card">
      <div style="font-size:1.05rem;color:var(--muted);margin-bottom:8px;">Valeur observ√©e</div>
      <div style="font-size:2rem;font-weight:800;color:var(--accent)">{valueText}</div>
      <div style="margin-top:6px;color:var(--muted);">
        En France : {frText}
        {!isFrance && <Fragment set:html={` ‚Üí <strong style="color:${d.color}">${d.text}</strong>`} />}
      </div>

      <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap">
        <a class="pill" href={`/country/${country.slug}`} title="Revenir √† la page pays">‚Üê Retour {country.name}</a>
        <a class="pill" href={`/country/${country.slug}/restaurant`}>Restaurant</a>
        <a class="pill" href={`/country/${country.slug}/salaire`}>Salaire</a>
        <a class="pill" href={`/country/${country.slug}/loyer`}>Loyer</a>
        <a class="pill" href={`/country/${country.slug}/essence`}>Essence</a>
        <a class="pill" href={`/country/${country.slug}/cinema`}>Cin√©ma</a>
        <a class="pill" href={`/country/${country.slug}/hotel`}>H√¥tel</a>
        <a class="pill" href={`/country/${country.slug}/habiter`}>Habiter</a>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0;">Notes rapides</h3>
      <ul style="margin:0;padding-left:1.1rem;color:var(--muted);line-height:1.6;">
        <li>Comparaison directe avec les prix moyens en France.</li>
        <li>Des √©carts existent selon la ville et la saison.</li>
        <li>Donn√©es mises √† jour automatiquement via GitHub Actions.</li>
      </ul>
    </div>
  </div>
</BaseLayout>
