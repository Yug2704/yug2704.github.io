---
import BaseLayout from "../../../layouts/BaseLayout.astro";

/* 1) Map CAT â†’ clÃ© KPI (utilisÃ© pour le rendu) */
const keyByCategoryPage: Record<string, string> = {
  restaurant: "restaurant",
  salaire: "salaireNet",
  loyer: "loyer",
  essence: "essence",
  cigarettes: "cigarettes",
  cinema: "cinema",
  hotel: "hotel",
  habiter: "habiterIndex",

  // ðŸ”¥ nouvelles catÃ©gories
  eau1l: "eau1l",
  transportLocal: "transportLocal",
  billetAvion: "billetAvion",
  train: "train",
  forfaitMobile: "forfaitMobile",
};

/* 2) Routes statiques â€” tout doit Ãªtre local Ã  la fonction */
export async function getStaticPaths() {
  // Copie locale (Ã©vite les soucis de scope/tree-shaking)
  const keyByCategory: Record<string, string> = {
    restaurant: "restaurant",
    salaire: "salaireNet",
    loyer: "loyer",
    essence: "essence",
    cigarettes: "cigarettes",
    cinema: "cinema",
    hotel: "hotel",
    habiter: "habiterIndex",

    // ðŸ”¥ nouvelles catÃ©gories
    eau1l: "eau1l",
    transportLocal: "transportLocal",
    billetAvion: "billetAvion",
    train: "train",
    forfaitMobile: "forfaitMobile",
  };

  const countryFiles = import.meta.glob("../../../data/countries/*.json", { eager: true }) as Record<string, any>;
  const COUNTRIES = Object.values(countryFiles).map((m: any) => m?.default ?? m);

  const catsMod = await import("../../../data/categories.json");
  const catsRaw: any[] = (catsMod as any).default ?? (catsMod as any);
  const cats: string[] = catsRaw.map((c: any) => (typeof c === "string" ? c : c?.slug)).filter(Boolean);

  const FR = COUNTRIES.find((c: any) => c?.slug === "france");

  const paths: any[] = [];
  for (const c of COUNTRIES) {
    for (const cat of cats) {
      const key = keyByCategory[cat];
      if (key && c?.kpis && key in c.kpis) {
        paths.push({
          params: { country: c.slug, category: cat },
          props: { country: c, category: cat, FR },
        });
      }
    }
  }
  return paths;
}

/* 3) Props + helpers */
const { country, category, FR } = Astro.props as { country: any; category: string; FR: any };

const labels: Record<string, string> = {
  restaurant: "Repas au restaurant",
  salaire: "Salaire mensuel net moyen",
  loyer: "Loyer mensuel (1 chambre, centre-ville)",
  essence: "Essence (L 95)",
  cigarettes: "Cigarettes (paquet)",
  cinema: "CinÃ©ma (1 place)",
  hotel: "HÃ´tel (1 nuit)",
  habiter: "Indice Â« Habiter Â»",

  // ðŸ”¥ nouvelles catÃ©gories
  eau1l: "Bouteille dâ€™eau (1 L)",
  transportLocal: "Transports en commun (ticket)",
  billetAvion: "Billet dâ€™avion A/R depuis la France",
  train: "Train (trajet interurbain)",
  forfaitMobile: "Forfait mobile (mensuel)",
};

const pluralNames: Record<string, string> = {
  restaurant: "restaurants",
  salaire: "salaires",
  loyer: "loyers",
  essence: "essence",
  cigarettes: "paquets de cigarettes",
  cinema: "cinÃ©ma",
  hotel: "hÃ´tels",
  habiter: "coÃ»t global du logement",

  // ðŸ”¥ nouvelles catÃ©gories
  eau1l: "bouteilles dâ€™eau de 1 L",
  transportLocal: "tickets de transports",
  billetAvion: "billets dâ€™avion",
  train: "trajets en train",
  forfaitMobile: "forfaits mobiles",
};

function eur(n?: number | null) {
  if (n == null) return "";
  return Number(n).toLocaleString("fr-FR", { style: "currency", currency: "EUR" });
}

function diffLabel(val?: number | null, ref?: number | null) {
  if (country.slug === "france") return { text: "rÃ©fÃ©rence France", color: "var(--muted)" };
  if (val == null || ref == null) return { text: "â€“", color: "var(--muted)" };
  const pct = ((val - ref) / ref) * 100;
  const abs = Math.abs(pct);
  if (!isFinite(pct)) return { text: "â€“", color: "var(--muted)" };
  if (abs < 1) return { text: "similaire", color: "var(--muted)" };
  return pct < 0
    ? { text: `${abs.toFixed(0)}% moins cher`, color: "var(--green)" }
    : { text: `${abs.toFixed(0)}% plus cher`,  color: "var(--red)" };
}

/* 4) DonnÃ©es calculÃ©es pour lâ€™affichage enrichi */
const key = keyByCategoryPage[category];
const val = country?.kpis?.[key];
const ref = FR?.kpis?.[key];
const d = diffLabel(val, ref);
const pctNum =
  val != null && ref != null && isFinite((val - ref) / ref) ? Math.round(((val - ref) / ref) * 100) : null;

const title = `${labels[category]} â€“ ${country?.name ?? ""}`;

/* Date de mise Ã  jour */
const lastUpdatedRaw = country.meta?.lastUpdated;
const lastUpdated = lastUpdatedRaw ? new Date(lastUpdatedRaw) : null;
const lastUpdatedStr = lastUpdated
  ? lastUpdated.toLocaleDateString("fr-FR", { year: "numeric", month: "long", day: "numeric" })
  : null;

/* BanniÃ¨re de catÃ©gorie (fallback si absente) */
const catBanner = `/banners/categories/${category}.jpg`;
const defaultBanner = `/banners/${country.slug}.jpg`;
const bannerSrc = catBanner;
---

<BaseLayout title={title}>
  <!-- BanniÃ¨re catÃ©gorie -->
  <div class="banner">
    <img src={bannerSrc} alt={`BanniÃ¨re ${labels[category]}`} />
  </div>

  <!-- Titre -->
  <h1 class="h1">
    {labels[category]} : <span class="country">{country.name}</span>
  </h1>

  {lastUpdatedStr && (
    <p class="last-updated">
      DonnÃ©es mises Ã  jour le {lastUpdatedStr}.
    </p>
  )}

  <!-- EncadrÃ© rÃ©sumÃ© -->
  <section class="summary">
    <div class="tile">
      <div class="t-label">Prix moyen</div>
      <div class="t-value">{eur(val)}</div>
    </div>
    <div class="tile">
      <div class="t-label">Ã‰cart vs France</div>
      <div class="t-value" style={`color:${d.color}`}>{country.slug === "france" ? "RÃ©fÃ©rence" : d.text}</div>
    </div>
    <div class="tile">
      <div class="t-label">RÃ©fÃ©rence France</div>
      <div class="t-value">{eur(ref)}</div>
    </div>
  </section>

  <!-- Texte court auto -->
  <section class="card">
    <h2 style="margin:0 0 .5rem 0;">Ã€ retenir</h2>
    <p class="muted" style="margin:0">
      Au {country.name.toLowerCase()}, les {pluralNames[category]} affichent en moyenne
      {pctNum === null
        ? " un niveau comparable Ã  la France."
        : pctNum === 0
          ? " un niveau similaire Ã  la France."
          : pctNum < 0
            ? ` un coÃ»t infÃ©rieur dâ€™environ ${Math.abs(pctNum)} % par rapport Ã  la France.`
            : ` un coÃ»t supÃ©rieur dâ€™environ ${pctNum} % par rapport Ã  la France.`}
      Les montants peuvent varier selon la ville et la saison.
    </p>
  </section>

  <!-- DÃ©tail -->
  <section class="detail-grid">
    <div class="card">
      <h3>Comment lire ces chiffres ?</h3>
      <ul class="muted">
        <li><strong>Prix moyen</strong> : estimation typique observÃ©e dans le pays.</li>
        <li><strong>Ã‰cart vs France</strong> : pour situer le budget rapidement.</li>
        <li><strong>RÃ©f. France</strong> : valeur de comparaison (ðŸ‡«ðŸ‡·).</li>
      </ul>
    </div>
    <div class="card">
      <h3>Astuce budget</h3>
      <p class="muted" style="margin:0">
        Compare des villes avant de te dÃ©cider. Par exemple, dans les grandes mÃ©tropoles, les prix
        peuvent Ãªtre sensiblement plus Ã©levÃ©s que la moyenne nationale.
      </p>
    </div>
  </section>

  <style>
    :root{ --green:#2f9e44; --red:#e03131; }
    .banner{margin:18px 0;border:1px solid var(--line);border-radius:18px;overflow:hidden;box-shadow:var(--shadow);}
    .banner img{width:100%;height:220px;object-fit:cover}
    .h1{font-size:1.8rem;margin:16px 0 4px 0}
    .country{color:var(--accent)}
    .summary{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;
      background:var(--accent-100);border:1px solid #ffd0df;border-radius:18px;padding:18px;box-shadow:var(--shadow);
      margin:12px 0 18px 0;
    }
    .tile{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
    .t-label{color:var(--muted);font-size:.95rem;margin-bottom:6px}
    .t-value{font-size:1.4rem;font-weight:700}
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:var(--shadow);margin-top:14px}
    .detail-grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));margin-top:14px}
    .muted{color:var(--muted)}
    .last-updated{
      margin:0 0 10px 0;
      font-size:0.9rem;
      color:var(--muted);
    }
  </style>
</BaseLayout>
