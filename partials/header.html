<header class="site-header">
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:16px;padding:14px 0">
    <a href="/" class="brand" style="display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit">
      <span class="brand-badge" style="display:inline-flex;width:32px;height:32px;align-items:center;justify-content:center;border-radius:999px;">€</span>
      <strong>prix de la vie</strong>
    </a>

    <nav class="main-nav" style="display:flex;gap:18px;align-items:center">
      <a href="/" style="text-decoration:none;color:inherit">Accueil</a>
      <a href="/categories/" style="text-decoration:none;color:inherit">Toutes les catégories</a>
      <a href="/cout-de-la-vie/" style="text-decoration:none;color:inherit">Coût de la vie</a>
      <!-- Header search (works site-wide) -->
      <form action="/recherche" method="GET" style="margin:0;display:flex;gap:8px">
        <input name="q" aria-label="Recherche" placeholder="Rechercher"
               style="border:1px solid #e5e7eb;border-radius:10px;padding:6px 10px"/>
        <button type="submit" style="border:1px solid #e5e7eb;border-radius:10px;padding:6px 10px;background:#111;color:#fff">OK</button>
      </form>
    </nav>
  </div>
  <hr style="border:none;border-top:1px solid #f1f5f9;margin:0">
</header>

<script>
/* --- Universal search handler (header + any <form action="/recherche">) --- */
(function(){
  function normalize(s){
    return (s||"").toLowerCase()
      .normalize('NFD').replace(/\p{Diacritic}/gu,'')
      .replace(/[^a-z0-9\s-]/g,' ')
      .replace(/\s+/g,' ').trim();
  }
  async function handleSearch(ev){
    ev.preventDefault();
    const form = ev.currentTarget;
    const qRaw = new FormData(form).get('q');
    const q = normalize(qRaw);
    if(!q) return;

    try{
      const res = await fetch('/data/locations.json',{cache:'no-store'});
      const db  = await res.json();

      // Build candidates (use BOTH object key and n.slug/n.name)
      const entries = Object.entries(db).map(([key,n])=>({key,n}));
      let best=null, bestScore=-1;

      for(const {key,n} of entries){
        if(!n) continue;
        const name = normalize(n.name);
        const slug = normalize(n.slug || key);
        // score: exact > start > include
        let s = -1;
        if(q === slug || q === name) s = 3;
        else if(slug.startsWith(q) || name.startsWith(q)) s = 2;
        else if(slug.includes(q) || name.includes(q)) s = 1;
        if(s > bestScore){ best = {slug:(n.slug||key)}, bestScore = s; }
      }

      if(best && best.slug){
        location.href = `/cout-de-la-vie/${best.slug}/`;
      }else{
        alert("Lieu non trouvé : " + qRaw);
      }
    }catch(e){
      console.error(e);
      alert("Recherche momentanément indisponible.");
    }
  }

  function bindAll(){
    document.querySelectorAll('form[action="/recherche"]').forEach(f=>{
      if(!f.__bound){ f.addEventListener('submit', handleSearch); f.__bound = true; }
    });
  }
  document.addEventListener('DOMContentLoaded', bindAll);
  new MutationObserver(bindAll).observe(document.documentElement,{subtree:true,childList:true});
})();
</script>